name: Deploy Next.js App (Production)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    if: github.repository == 'Sourcepride/stacktrails'
    runs-on: ubuntu-latest
    environment: stacktrails
    env:
      NODE_ENV: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v3
        with:
          version: 10.20.0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24.11.0
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Create .env.production file
        run: |
          echo "NODE_ENV=production" > .env.production
          echo "NEXT_PUBLIC_GOOGLE_CLIENT_ID=${{ vars.NEXT_PUBLIC_GOOGLE_CLIENT_ID }}" >> .env.production
          echo "NEXT_PUBLIC_BACKEND_URL=${{ vars.NEXT_PUBLIC_BACKEND_URL }}" >> .env.production
          echo "NEXT_IMAGE_OPTS_TIMEOUT=${{ vars.NEXT_IMAGE_OPTS_TIMEOUT }}" >> .env.production
          echo "NEXT_PUBLIC_WS_URL=${{ vars.NEXT_PUBLIC_WS_URL }}" >> .env.production
          echo "NEXT_PUBLIC_SITE_URL=${{ vars.NEXT_PUBLIC_SITE_URL }}" >> .env.production
          echo "NEXT_PUBLIC_API_URL=${{ vars.NEXT_PUBLIC_API_URL }}" >> .env.production
          echo "NEXT_PUBLIC_GOOGLE_API_KEY=${{ vars.NEXT_PUBLIC_GOOGLE_API_KEY }}" >>  .env.production
          echo "NEXT_PUBLIC_GOOGLE_APP_ID=${{ vars.NEXT_PUBLIC_GOOGLE_APP_ID }}" >>  .env.production
          echo "‚úÖ .env.production file created"

      - name: Build Next.js app

        run: pnpm build

      - name: Create build archive
        run: tar -czf next-build.tar.gz .next .env.production

      - name: Copy build to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "next-build.tar.gz"
          target: "/home/${{ secrets.SERVER_USER }}/stacktrails"
          strict: false

      - name: Deploy on server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          strict: false
          script: |
            cd /home/${{ secrets.SERVER_USER }}/stacktrails

            echo "üîÑ Syncing with repository..."
            git fetch origin main
            git merge --ff-only origin/main || git reset --hard origin/main

            export PNPM_HOME="$HOME/.local/share/pnpm"
            export PATH="$PNPM_HOME:$PATH"

            # Load Node from NVM
            export NVM_DIR="$HOME/.nvm"
            source "$NVM_DIR/nvm.sh"
            nvm use --silent 20 || true

            echo "Node version: $(node -v)"
            echo "pnpm version: $(pnpm -v)"
            echo "pm2 version: $(pm2 -v)"


            echo "üì¶ Installing dependencies..."
            pnpm install --frozen-lockfile

            echo "üóëÔ∏è  Removing old build and env..."
            rm -rf .next
            rm -f .env.production

            echo "üìÇ Extracting new build..."
            tar -xzf next-build.tar.gz
            rm next-build.tar.gz

            echo "‚ôªÔ∏è  Restarting PM2..."
            pm2 reload stacktrails || pm2 start npm --name stacktrails -- start
            pm2 save

            echo "‚úÖ Deployment complete!"
